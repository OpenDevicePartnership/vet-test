# This workflow runs whenever a PR is opened or updated. It runs cargo vet to check for unvetted dependencies in the Cargo.lock file.
permissions:
    contents: read
on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

name: cargo-vet
jobs:
  commit_list:
    uses: ./.github/workflows/commit-list.yml
    with:
      event_name: ${{ github.event_name }}
      base_ref: ${{ github.base_ref }}
      head_sha: ${{ github.event.pull_request.head.sha }}
  
  vet:
    # cargo-vet checks for unvetted dependencies in the Cargo.lock file
    # This is to ensure that new dependencies are vetted before they are added to the project
    name: Vet Dependencies
    runs-on: ubuntu-latest
    needs: commit_list
    env:
      CARGO_VET_VERSION: 0.10.1
    
    strategy:
      fail-fast: false
      matrix:
        commit: ${{ fromJSON(needs.commit_list.outputs.commits) }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
        ref: ${{ matrix.commit }}

    - uses: actions/cache@v4
      with:
        path: ${{ runner.tool_cache }}/cargo-vet
        key: cargo-vet-bin-${{ env.CARGO_VET_VERSION }}

    - name: Add the tool cache directory to the search path
      run: echo "${{ runner.tool_cache }}/cargo-vet/bin" >> $GITHUB_PATH

    - name: Ensure that the tool cache is populated with the cargo-vet binary
      run: cargo install --root ${{ runner.tool_cache }}/cargo-vet --version ${{ env.CARGO_VET_VERSION }} cargo-vet

    - name: Invoke cargo-vet
      run: cargo vet --locked
    
    - name: Save PR number
      if: ${{ failure() }} || ${{ success() }}
      run: |
        mkdir -p ./pr
        echo ${{ github.event.number }} > ./pr/NR
    - uses: actions/upload-artifact@v4
      if: ${{ failure() }} || ${{ success() }}
      with:
        name: pr
        path: pr/
        overwrite: true